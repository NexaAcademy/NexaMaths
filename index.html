<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Nexa Academy (Maths)</title>

  <!-- Google Font: Noto Sans Sinhala -->
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Sinhala:wght@400;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --brand:#1d3557;
      --accent:#e63946;
      --muted:#6c757d;
      --bg:#f7f9fc;
      --card:#ffffff;
      --success:#2a9d8f;
    }

    html,body{height:100%;}
    body{
      margin:0;
      font-family: "Noto Sans Sinhala", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      background: linear-gradient(180deg, #f7fbff 0%, #ffffff 100%);
      color:#111;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:20px;
    }

    .container{
      width:100%;
      max-width:720px;
      background:var(--card);
      border-radius:12px;
      box-shadow:0 8px 30px rgba(20,30,70,0.08);
      padding:18px;
      box-sizing:border-box;
    }

    header{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;}
    header h1{font-size:18px;margin:0;color:var(--brand);}
    header p{margin:0;font-size:12px;color:var(--muted);}

    .screen{display:none;}
    .screen.active{display:block;}

    /* form */
    label{display:block;font-weight:600;margin-bottom:6px;font-size:14px;}
    .hint{font-weight:400;color:var(--muted);font-size:13px;margin-bottom:12px;}
    input[type="text"], input[type="tel"]{
      width:100%;
      padding:12px 14px;
      border-radius:8px;
      border:1px solid #e9eef6;
      box-sizing:border-box;
      font-size:15px;
      margin-bottom:10px;
    }

    .row{display:flex;gap:12px;}
    .row .col{flex:1;}

    button{
      display:inline-block;
      background:var(--brand);
      color:#fff;
      border:none;
      padding:12px 16px;
      border-radius:10px;
      font-weight:700;
      cursor:pointer;
      font-size:15px;
    }
    button.secondary{
      background:#fff;
      color:var(--brand);
      border:1px solid #d6e2f0;
      font-weight:600;
    }

    .card{background:var(--bg);padding:14px;border-radius:10px;margin:10px 0;}
    .instruction-box{
      border-left:4px solid var(--accent);
      padding:12px 14px;
      background:linear-gradient(180deg,#fff 0%,#fbfdff 100%);
      border-radius:8px;
      margin-bottom:12px;
      font-size:15px;
    }

    .question{
      font-size:17px;
      margin-bottom:12px;
      font-weight:600;
    }
    .question img{
      max-width:100%;
      display:block;
      margin:12px auto;
      border-radius:8px;
      box-shadow:0 6px 18px rgba(30,40,80,0.06);
    }

    .answers{display:flex;flex-direction:column;gap:10px;margin-bottom:12px;}
    .answer-btn{
      background:#fff;
      border:1px solid #e6eef8;
      padding:12px;
      border-radius:10px;
      text-align:left;
      cursor:pointer;
      font-weight:600;
      color:#111;
    }
    .answer-btn.selected{border-color:var(--brand);background:#eef6ff;}
    .small{font-size:13px;color:var(--muted);}

    .error{color:var(--accent);font-weight:700;margin-bottom:8px;}
    .success{color:var(--success);font-weight:700;margin-bottom:8px;}

    footer{
      margin-top:18px;
      padding-top:12px;
      border-top:1px dashed #edf3fb;
      display:flex;
      align-items:center;
      justify-content:space-between;
      font-size:13px;
      color:var(--muted);
    }

    /* Math styling - FIXED */
    sup {
      font-size: 0.8em;
      vertical-align: super;
      font-weight: 600;
      /* Removed red color - using default */
    }
    
    sub {
      font-size: 0.8em;
      vertical-align: sub;
      color: var(--muted);
    }
    
    .matrix-container {
      display: inline-block;
      margin: 5px 0;
      vertical-align: middle;
    }
    
    .matrix-table {
      border-collapse: collapse;
      display: inline-table;
      margin: 0 5px;
      border: 2px solid var(--brand);
      border-radius: 6px;
      overflow: hidden;
      background: white;
    }
    
    .matrix-table td {
      padding: 10px 14px;
      text-align: center;
      border: 1px solid #e0e0e0;
      min-width: 35px;
      font-weight: 600;
      color: var(--brand);
      font-size: 14px;
    }
    
    .matrix-table tr:first-child td {
      border-top: 2px solid var(--brand);
    }
    
    .matrix-table tr:last-child td {
      border-bottom: 2px solid var(--brand);
    }
    
    .matrix-table td:first-child {
      border-left: 2px solid var(--brand);
    }
    
    .matrix-table td:last-child {
      border-right: 2px solid var(--brand);
    }
    
    .fraction {
      display: inline-block;
      text-align: center;
      vertical-align: middle;
      margin: 0 2px;
      font-size: 14px; /* Medium size for fractions */
    }
    
    .numerator, .denominator {
      display: block;
      padding: 0 4px;
    }
    
    .denominator {
      border-top: 1px solid #888;
      padding-top: 2px;
      margin-top: 2px;
    }

    /* responsive */
    @media (max-width:480px){
      .container{padding:14px;border-radius:10px;}
      header h1{font-size:15px;}
      .question{font-size:16px;}
      .matrix-table td {
        padding: 6px 8px;
        min-width: 25px;
        font-size: 12px;
      }
      .fraction {
        font-size: 13px;
      }
    }
  </style>
</head>
<body>
  <div class="container" role="main">
    <header>
      <h1>O/L Math Quiz — Nexa Maths | Dasun Sankalpa</h1>
      <p class="small">Nexa Academy</p>
    </header>

    <!-- LOGIN SCREEN -->
    <div id="screen-login" class="screen active" aria-live="polite">
      <div class="card">
        <label for="studentName">Your Name (ඔබේ නම)</label>
        <input id="studentName" type="text" placeholder="e.g. Kavidu Pathirana / කවිදු පතිරණ" />

        <label for="whatsappNumber">WhatsApp Number (ඔබේ WhatsApp අංකය)</label>
        <input id="whatsappNumber" type="tel" placeholder="07xxxxxxxx" maxlength="10" />

        <label for="parentNumber">Parent's Contact No (දෙමාපියන්ගේ දුරකථන අංකය)</label>
        <input id="parentNumber" type="tel" placeholder="07xxxxxxxx" maxlength="10" />

        <div id="loginError" class="error" style="display:none;"></div>

        <div style="display:flex;gap:10px;margin-top:10px;">
          <button id="startBtn">Start Quiz (ප්‍රශ්න පත්‍රය අරඹන්න)</button>
          <button id="clearBtn" class="secondary">Clear (මකා දමන්න)</button>
        </div>
        <p class="hint">Please enter your full name and valid Sri Lankan phone numbers (10 digits, starting with 07).<br>කරුණාකර ඔබේ සත්‍ය නම සහ නිවැරදි ශ්‍රී ලාංකීය දුරකථන අංක ඇතුළත් කරන්න (10 අංකය, 07… සහ ආරම්භ විය යුතුය).</p>
      </div>
    </div>

    <!-- INSTRUCTION SCREEN -->
    <div id="screen-instructions" class="screen" aria-live="polite">
      <div class="instruction-box">
        <!-- Exact Sinhala message as requested -->
        පුතේ මේ ප්‍රශ්න වලට පිළිතුරු සපයන්න. මෙමගින් ඔයාගේ දැන් මට්ටම අඳුර ගන්නවා. එම නිසා අවංකව මේ වැඩේ කරන්න. ඔයාගේ සාධන මට්ටම අඳුරගෙන ඔයාගේ A එක ගන්න අපි උදව් කරනවා. මේ ප්‍රශ්න පොතක හදලා පිළිතුර Submit කරන්න.
      </div>
      <div style="display:flex;gap:10px;">
        <button id="beginQuizBtn">I Understand — Begin (මාට තේරෙනවා — අරඹන්න)</button>
        <button id="backToLoginBtn" class="secondary">Back (පසු වෙන්න)</button>
      </div>
    </div>

    <!-- QUIZ SCREEN -->
    <div id="screen-quiz" class="screen" aria-live="polite">
      <div id="quizCard" class="card">
        <div id="questionIndex" class="small"></div>
        <div id="questionText" class="question"></div>
        <div id="questionImage"></div>
        <div id="answers" class="answers"></div>
        <div id="quizError" class="error" style="display:none;"></div>

        <div style="display:flex;gap:10px;margin-top:12px;">
          <button id="prevBtn" class="secondary" style="display:none;">← Previous (පෙර ප්‍රශ්නය)</button>
          <button id="nextBtn">Next (මීළඟ)</button>
          <button id="submitBtn" class="secondary" style="display:none;">Submit (පිළිතුරු යවන්න)</button>
        </div>
      </div>
    </div>

    <!-- RESULT SCREEN -->
    <div id="screen-result" class="screen" aria-live="polite">
      <div class="card">
        <h2 id="resultTitle">Quiz Complete (ප්‍රශ්න පත්‍රය නිමවූවා)</h2>
        <p id="resultMessage" class="small"></p>
        <div id="sendStatus" class="small" style="margin-top:8px;"></div>
        <!-- Removed the Take Again button completely -->
      </div>
    </div>

    <footer>
      <div>Dasun Sankalpa (Nexa Academy)</div>
      <div class="small">© <span id="year"></span></div>
    </footer>
  </div>

  <script>
    // ========= CONFIG =============
    const WEBAPP_URL = 'https://script.google.com/macros/s/AKfycbw8-SycTxiAvSntizxAKdejXcls5vVYXiiMKcQSMWNAjn8LEKSZze30AocwdS1t1Ne5gA/exec'; // <-- REPLACE THIS with your deployed Web App URL

    // ========= END CONFIG =========

    // Helper: show current year in footer
    document.getElementById('year').textContent = new Date().getFullYear();

    // UI elements
    const screenLogin = document.getElementById('screen-login');
    const screenInstructions = document.getElementById('screen-instructions');
    const screenQuiz = document.getElementById('screen-quiz');
    const screenResult = document.getElementById('screen-result');

    const startBtn = document.getElementById('startBtn');
    const clearBtn = document.getElementById('clearBtn');
    const beginQuizBtn = document.getElementById('beginQuizBtn');
    const backToLoginBtn = document.getElementById('backToLoginBtn');

    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    const submitBtn = document.getElementById('submitBtn');

    const studentNameInput = document.getElementById('studentName');
    const whatsappInput = document.getElementById('whatsappNumber');
    const parentInput = document.getElementById('parentNumber');

    const loginError = document.getElementById('loginError');
    const quizError = document.getElementById('quizError');
    const questionIndexEl = document.getElementById('questionIndex');
    const questionTextEl = document.getElementById('questionText');
    const questionImageEl = document.getElementById('questionImage');
    const answersEl = document.getElementById('answers');
    const resultMessage = document.getElementById('resultMessage');
    const sendStatus = document.getElementById('sendStatus');

    // Utility: show screen
    function showScreen(el) {
      [screenLogin, screenInstructions, screenQuiz, screenResult].forEach(s => s.classList.remove('active'));
      el.classList.add('active');
    }

    // Validation: Sri Lankan mobile numbers: 10 digits, starting with 07
    function isValidSriLankanMobile(num) {
      if (!num) return false;
      num = num.toString().trim().replace(/[^0-9]/g, '');
      return /^07\d{8}$/.test(num);
    }

    // Start button from login: validate and show instructions
    startBtn.addEventListener('click', () => {
      loginError.style.display = 'none';
      const name = studentNameInput.value.trim();
      const w = whatsappInput.value.trim();
      const p = parentInput.value.trim();

      if (!name) {
        loginError.textContent = 'Please enter your name (කරුණාකර ඔබේ නම ඇතුළත් කරන්න).';
        loginError.style.display = 'block';
        return;
      }
      if (!isValidSriLankanMobile(w) || !isValidSriLankanMobile(p)) {
        loginError.textContent = 'Please enter a valid Sri Lankan phone number (කරුණාකර නිවැරදි දුරකථන අංකයක් ඇතුළත් කරන්න).';
        loginError.style.display = 'block';
        return;
      }

      // Save to local storage
      localStorage.setItem('quiz_studentName', name);
      localStorage.setItem('quiz_whatsappNumber', w.replace(/[^0-9]/g,''));
      localStorage.setItem('quiz_parentNumber', p.replace(/[^0-9]/g,''));

      showScreen(screenInstructions);
    });

    clearBtn.addEventListener('click', () => {
      studentNameInput.value = '';
      whatsappInput.value = '';
      parentInput.value = '';
      loginError.style.display = 'none';
    });

    backToLoginBtn.addEventListener('click', () => showScreen(screenLogin));

    // ========== QUIZ DATA ============
    const questions = [
    {
        id: 1,
        text: '1. රු. 5000 ක වටිනාකමකින් යුත් විදුලි උපකරණයක් ආනයනය කිරීමේදී 10% ක තීරු බද්දක් අය කරයි නම්, ගෙවිය යුතු තීරු බදු මුදල කීයද?',
        options: ['රු. 400', 'රු. 500', 'රු. 5000', 'රු. 4500'],
        correct: 1,
        image: null
    },
    {
        id: 2,
        text: '2. x² - 9 හි සාධක වනුයේ?',
        options: ['(x - 3)(x - 3)', '(x + 3)(x + 3)', '(x - 3)(x + 3)', '(x - 9)(x + 1)'],
        correct: 2,
        image: null
    },
    {
        id: 3,
        text: '3. රූපයේ x හි අගය සොයන්න.',
        options: ['100°', '110°', '130°', '70°'],
        correct: 1,
        image: 'images/3.png'
    },
    {
        id: 4,
        text: '4. සුළු කරන්න: ²⁄₃ₓ + ¹⁄ₓ',
        options: ['<div class="fraction"><span class="numerator">3</span><span class="denominator">4x</span></div>', 
                  '<div class="fraction"><span class="numerator">3</span><span class="denominator">3x</span></div>', 
                  '<div class="fraction"><span class="numerator">5</span><span class="denominator">3x</span></div>', 
                  '<div class="fraction"><span class="numerator">2</span><span class="denominator">3x²</span></div>'],
        correct: 2,
        image: null
    },
    {
        id: 5,
        text: '5. log₂ 16 = 4 යන්න දර්ශක ආකාරයෙන් ලියන්න.',
        options: ['2<sup>4</sup> = 16', '4<sup>2</sup> = 16', '16<sup>2</sup> = 4', '2<sup>16</sup> = 4'],
        correct: 0,
        image: null
    },
    {
        id: 6,
        text: '6. A = {1, 3, 5, 7} සහ B = {1, 2, 3} නම් A ∩ B කුලකය වනුයේ?',
        options: ['{1,2,3,5,7}', '{1,3}', '{5,7}', '{2}'],
        correct: 1,
        image: null
    },
    {
        id: 7,
        text: '7. අරය 7cm වූ වෘත්තයක පරිධිය සොයන්න.',
        options: ['22cm', '44cm', '154cm', '38.5cm'],
        correct: 1,
        image: null
    },
    {
        id: 8,
        text: '8. රූපයේ ABCD වෘත්ත චතුරස්‍රයේ x කෝණය සොයන්න.',
        options: ['80°', '100°', '90°', '180°'],
        correct: 0,
        image: 'images/8.png'
    },
    {
        id: 9,
        text: '9. 2x - 1 = 9 සරල සමීකරණය විසඳන්න.',
        options: ['x = 4', 'x = 5', 'x = 8', 'x = 10'],
        correct: 1,
        image: null
    },
    {
        id: 10,
        text: '10. මිනිසුන් 4 දෙනෙකුට වැඩක් නිම කිරීමට දින 6ක් ගතවේ නම්, දින 3කින් නිම කිරීමට කොපමණ මිනිසුන් අවශ්‍යද?',
        options: ['6', '8', '12', '2'],
        correct: 1,
        image: null
    },
    {
        id: 11,
        text: '11. රූපයේ ABC සෘජුකෝණී ත්‍රිකෝණයේ tan θ සොයන්න.',
        options: ['<div class="fraction"><span class="numerator">3</span><span class="denominator">4</span></div>', 
                  '<div class="fraction"><span class="numerator">4</span><span class="denominator">3</span></div>', 
                  '<div class="fraction"><span class="numerator">3</span><span class="denominator">5</span></div>', 
                  '<div class="fraction"><span class="numerator">4</span><span class="denominator">5</span></div>'],
        correct: 0,
        image: 'images/11.png'
    },
    {
        id: 12,
        text: '12. 2, 5, 8, ... සමාන්තර ශ්‍රේඪියේ පොදු අන්තරය කීයද?',
        options: ['2', '3', '5', '8'],
        correct: 1,
        image: null
    },
    {
        id: 13,
        text: '13. 6x සහ 4x² යන වීජීය පදවල කු.පො.ගු සොයන්න.',
        options: ['2x', '12x', '12x<sup>2</sup>', '24x<sup>2</sup>'],
        correct: 2,
        image: null
    },
    {
        id: 14,
        text: '14. y = 3x - 2 සරල රේඛාවේ අනුක්‍රමණය (m) කොපමණද?',
        options: ['3', '-2', '2', '-3'],
        correct: 0,
        image: null
    },
    {
        id: 15,
        text: '15. රූපයේ කේන්ද්‍රය O වේ. x කේන්ද්‍රික කෝණය සොයන්න.',
        options: ['25°', '50°', '100°', '90°'],
        correct: 2,
        image: 'images/15.png'
    },
    {
        id: 16,
        text: '16. පහත න්‍යාස දෙක එකතු කරන්න: <br><br><table style="display:inline-table; margin:0 15px;"><tr><td style="padding:8px 12px; border:1px solid #ccc; text-align:center; font-weight:bold;">1</td><td style="padding:8px 12px; border:1px solid #ccc; text-align:center; font-weight:bold;">2</td></tr><tr><td style="padding:8px 12px; border:1px solid #ccc; text-align:center; font-weight:bold;">3</td><td style="padding:8px 12px; border:1px solid #ccc; text-align:center; font-weight:bold;">4</td></tr></table> + <table style="display:inline-table; margin:0 15px;"><tr><td style="padding:8px 12px; border:1px solid #ccc; text-align:center; font-weight:bold;">2</td><td style="padding:8px 12px; border:1px solid #ccc; text-align:center; font-weight:bold;">-1</td></tr><tr><td style="padding:8px 12px; border:1px solid #ccc; text-align:center; font-weight:bold;">-1</td><td style="padding:8px 12px; border:1px solid #ccc; text-align:center; font-weight:bold;">3</td></tr></table>',
        options: [
        '<div class="matrix-container"><table class="matrix-table"><tr><td>3</td><td>1</td></tr><tr><td>2</td><td>7</td></tr></table></div>',
        '<div class="matrix-container"><table class="matrix-table"><tr><td>3</td><td>0</td></tr><tr><td>0</td><td>7</td></tr></table></div>',
        '<div class="matrix-container"><table class="matrix-table"><tr><td>2</td><td>1</td></tr><tr><td>2</td><td>12</td></tr></table></div>',
        '<div class="matrix-container"><table class="matrix-table"><tr><td>1</td><td>1</td></tr><tr><td>-2</td><td>-1</td></tr></table></div>'
        ],
        correct: 0,
        image: null
    },
    {
        id: 17,
        text: '17. අසමානතාවය විසඳන්න: 2x ≤ 8',
        options: ['x ≤ 4', 'x ≥ 4', 'x < 4', 'x = 4'],
        correct: 0,
        image: null
    },
    {
        id: 18,
        text: '18. පැත්ත 2cm වූ ඝනකයක පරිමාව සොයන්න.',
        options: ['4 cm<sup>3</sup>', '6 cm<sup>3</sup>', '8 cm<sup>3</sup>', '12 cm<sup>3</sup>'],
        correct: 2,
        image: null
    },
    {
        id: 19,
        text: '19. පෙට්ටියේ රතු 3, නිල් 2. රතු බෝලයක් හසු වීමේ සම්භාවිතාව?',
        options: ['<div class="fraction"><span class="numerator">2</span><span class="denominator">5</span></div>', 
                  '<div class="fraction"><span class="numerator">3</span><span class="denominator">5</span></div>', 
                  '<div class="fraction"><span class="numerator">1</span><span class="denominator">2</span></div>', 
                  '<div class="fraction"><span class="numerator">1</span><span class="denominator">5</span></div>'],
        correct: 1,
        image: null
    },
    {
        id: 20,
        text: '20. රූපයේ AB ස්පර්ශකය, OP අරය. x කෝණය සොයන්න.',
        options: ['45°', '60°', '90°', '180°'],
        correct: 2,
        image: 'images/20.png'
    },
    {
        id: 21,
        text: '21. (a + b)<sup>2</sup> ප්‍රසාරණය කළ විට ලැබෙන්නේ?',
        options: ['a<sup>2</sup> + b<sup>2</sup>', 'a<sup>2</sup> + ab + b<sup>2</sup>', 'a<sup>2</sup> + 2ab + b<sup>2</sup>', '2a + 2b'],
        correct: 2,
        image: null
    },
    {
        id: 22,
        text: '22. වාහනයක් පැය 2ක දී 120 km ගමන් කරයි. වේගය සොයන්න.',
        options: ['60 km/h', '120 km/h', '240 km/h', '100 km/h'],
        correct: 0,
        image: null
    },
    {
        id: 23,
        text: '23. රූපයේ AB සහ CD රේඛා සමාන්තර වේ. x කෝණය සොයන්න.',
        options: ['110°', '70°', '180°', '20°'],
        correct: 1,
        image: 'images/23.png'
    },
    {
        id: 24,
        text: '24. 3, 3, 4, 5, 5, 5, 7, 8 සංඛ්‍යා සමූහයේ මාතය (Mode) කුමක්ද?',
        options: ['3', '4', '5', '6'],
        correct: 2,
        image: null
    },
    {
        id: 25,
        text: '25. x = 2 සහ y = -1 නම් 3x + y කුමක්ද?',
        options: ['5', '6', '7', '4'],
        correct: 0,
        image: null
    }
    ];

    // Variables for quiz state
    let currentIndex = 0;
    let selectedAnswer = null;
    let answersGiven = new Array(questions.length).fill(null);

    // Function to render matrix
    function renderMatrix(matrixStr) {
      try {
        const matrix = JSON.parse(matrixStr);
        let html = '<div class="matrix-container">';
        html += '<table class="matrix-table">';
        matrix.forEach(row => {
          html += '<tr>';
          row.forEach(cell => {
            html += `<td>${cell}</td>`;
          });
          html += '</tr>';
        });
        html += '</table></div>';
        return html;
      } catch (e) {
        return matrixStr;
      }
    }

    // Function to format mathematical text
    function formatMathText(text) {
      return text;
    }

    // Render a question
    function renderQuestion() {
      quizError.style.display = 'none';
      const q = questions[currentIndex];
      
      questionIndexEl.textContent = `ප්‍රශ්නය ${currentIndex + 1} / ${questions.length}`;
      questionTextEl.innerHTML = formatMathText(q.text);

      // Image rendering
      questionImageEl.innerHTML = '';
      if (q.image) {
        const img = document.createElement('img');
        img.src = q.image;
        img.alt = 'ප්‍රශ්න රූපය';
        img.style.maxHeight = '400px';
        img.style.maxWidth = '100%';
        questionImageEl.appendChild(img);
      }

      // Answers rendering
      answersEl.innerHTML = '';
      q.options.forEach((opt, idx) => {
        const btn = document.createElement('button');
        btn.className = 'answer-btn';
        btn.type = 'button';
        
        // Check if option is already HTML formatted (for matrices/fractions)
        if (typeof opt === 'string' && (opt.includes('matrix-container') || opt.includes('fraction'))) {
          btn.innerHTML = `${String.fromCharCode(65 + idx)}) ${opt}`;
        } else if (typeof opt === 'string' && opt.includes('[[') && opt.includes(']]')) {
          btn.innerHTML = `${String.fromCharCode(65 + idx)}) ${renderMatrix(opt)}`;
        } else {
          btn.innerHTML = `${String.fromCharCode(65 + idx)}) ${formatMathText(opt)}`;
        }
        
        btn.dataset.index = idx;
        btn.addEventListener('click', () => {
          document.querySelectorAll('.answer-btn').forEach(b => b.classList.remove('selected'));
          btn.classList.add('selected');
          selectedAnswer = idx;
          answersGiven[currentIndex] = idx; // Save answer immediately when selected
        });
        answersEl.appendChild(btn);
      });

      // Preselect previously given answer
      const prev = answersGiven[currentIndex];
      if (prev !== undefined && prev !== null) {
        const btnToSelect = answersEl.querySelector(`button[data-index="${prev}"]`);
        if (btnToSelect) {
          btnToSelect.classList.add('selected');
          selectedAnswer = prev;
        }
      } else {
        selectedAnswer = null;
      }

      // Manage button visibility
      prevBtn.style.display = currentIndex > 0 ? 'inline-block' : 'none';
      
      if (currentIndex === questions.length - 1) {
        nextBtn.style.display = 'none';
        submitBtn.style.display = 'inline-block';
      } else {
        nextBtn.style.display = 'inline-block';
        submitBtn.style.display = 'none';
      }
    }

    // Begin quiz: reset state and show first question
    beginQuizBtn.addEventListener('click', () => {
      const name = localStorage.getItem('quiz_studentName') || '';
      const w = localStorage.getItem('quiz_whatsappNumber') || '';
      const p = localStorage.getItem('quiz_parentNumber') || '';

      if (!name || !w || !p) {
        loginError.textContent = 'Session expired — please re-enter your details (පැවැත්වීම අවසන් විය).';
        loginError.style.display = 'block';
        showScreen(screenLogin);
        return;
      }

      // Reset quiz state but keep any previously answered questions
      currentIndex = 0;
      selectedAnswer = null;
      renderQuestion();
      showScreen(screenQuiz);
    });

    // Previous button: go back to previous question
    prevBtn.addEventListener('click', () => {
      if (selectedAnswer !== null) {
        answersGiven[currentIndex] = selectedAnswer;
      }
      currentIndex--;
      selectedAnswer = answersGiven[currentIndex];
      renderQuestion();
    });

    // Next button: go to next question
    nextBtn.addEventListener('click', () => {
      if (selectedAnswer === null) {
        quizError.textContent = 'Please select an answer before proceeding. (කරුණාකර පිලිතුරක් තෝරන්න.)';
        quizError.style.display = 'block';
        return;
      }
      // Save answer
      answersGiven[currentIndex] = selectedAnswer;

      // move next
      currentIndex++;
      selectedAnswer = answersGiven[currentIndex];
      renderQuestion();
    });

    // Submit: finalize, calculate score, send to Google Apps Script
    submitBtn.addEventListener('click', () => {
      quizError.style.display = 'none';
      if (selectedAnswer === null && answersGiven[currentIndex] === null) {
        quizError.textContent = 'Please select an answer before submitting. (කරුණාකර පිලිතුරක් තෝරන්න.)';
        quizError.style.display = 'block';
        return;
      }
      // save last answer if selected
      if (selectedAnswer !== null) answersGiven[currentIndex] = selectedAnswer;

      // Calculate score
      let score = 0;
      questions.forEach((q, idx) => {
        if (answersGiven[idx] === q.correct) score++;
      });

      // Show result and send to backend
      const studentName = localStorage.getItem('quiz_studentName') || '';
      const whatsappNumber = localStorage.getItem('quiz_whatsappNumber') || '';
      const parentNumber = localStorage.getItem('quiz_parentNumber') || '';
      const timestamp = new Date().toISOString();

      resultMessage.innerHTML = `
        <div style="text-align: center; padding: 20px 0;">
          <h3 style="color: var(--success); margin-bottom: 15px;">✔ ප්‍රශ්න පත්‍රය සම්පූර්ණයි!</h3>
          <p><strong>${escapeHtml(studentName)}</strong> ඔබගේ ලකුණු: <strong>${score} / ${questions.length}</strong></p>
          <p style="color: var(--muted); font-size: 14px; margin-top: 10px;">
            ඔබගේ ප්‍රතිඵල Nexa Academy වෙත යොමු කරන ලදී.<br>
            ඉක්මනින් ඔබගේ විශ්ලේෂණය සමඟ සම්බන්ධ වෙන්නෙමු.
          </p>
        </div>
      `;
      sendStatus.textContent = 'ප්‍රතිඵල සුරකිමින්...';
      showScreen(screenResult);

      // POST to Google Apps Script Web App
      if (!WEBAPP_URL || WEBAPP_URL === 'X') {
        sendStatus.textContent = 'Failed to send — please configure the WEBAPP_URL in the code. (WEBAPP_URL සකසන්න.)';
        return;
      }

      // Prepare payload
      const payload = {
        studentName: studentName,
        whatsappNumber: whatsappNumber,
        parentNumber: parentNumber,
        score: score,
        total: questions.length,
        timestamp: timestamp,
        answers: answersGiven
      };

      // Send request
      fetch(WEBAPP_URL, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(payload)
      })
      .then(response => response.json())
      .then(res => {
        if (res && res.status === 'success') {
          sendStatus.innerHTML = '<span class="success">✔ ප්‍රතිඵල සාර්ථකව සුරකින ලදී.</span>';
        } else {
          sendStatus.innerHTML = '<span class="error">ප්‍රතිඵල සුරකින්න ප්‍රශ්නයක් ඇත.</span>';
          console.error('Save response', res);
        }
      })
      .catch(err => {
        sendStatus.innerHTML = '<span class="error">ප්‍රතිඵල යැවීමට අසමත් විය.</span>';
        console.error('Error sending to WEBAPP_URL:', err);
      });
    });

    // Escape HTML to avoid injection
    function escapeHtml(str) {
      return String(str).replace(/[&<>"'`=\/]/g, function(s) {
        return {
          '&': '&amp;',
          '<': '&lt;',
          '>': '&gt;',
          '"': '&quot;',
          "'": '&#39;',
          '/': '&#x2F;',
          '`': '&#x60;',
          '=': '&#x3D;'
        }[s];
      });
    }

    // Preload images
    window.addEventListener('load', () => {
      questions.forEach(q => {
        if (q.image) {
          const img = new Image();
          img.src = q.image;
        }
      });
    });
  </script>
</body>
</html>